# This is an EC2Launch V2 type user-data script
# https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2launch-v2-settings.html#ec2launch-v2-task-configuration
# See C:\ProgramData\Amazon\EC2Launch\log for logs
version: 1.0
tasks:
  - task: executeScript
    inputs:
      - frequency: once
        type: powershell
        runAs: admin
        #not actually a secret
        #checkov:skip=CKV_SECRET_6: "Base64 High Entropy String"
        content: |  
          # $ErrorActionPreference = "Stop" # set all errors to terminate script

          Set-TimeZone "GMT Standard Time"
          Set-WinSystemLocale "en-GB"

          # Check CWAgent is installed, if it isn't then install it
          $timeout = New-TimeSpan -Seconds 600
          $endTime = (Get-Date).Add($timeout)
          $cwagent = Get-Service -Name "AmazonCloudWatchAgent"
          if ($cwagent) {
            Do {
            & "C:\Program Files\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent-ctl.ps1" -a fetch-config -m ec2 -s -c ssm:cloud-watch-config-windows
            } Until ((Get-Service -Name "AmazonCloudWatchAgent" | Where-Object {$_.Status -eq "Running"}) -or ((Get-Date) -gt $endTime))
          } else {
            Invoke-WebRequest -Uri "https://s3.amazonaws.com/amazoncloudwatch-agent/windows/amd64/latest/amazon-cloudwatch-agent.msi" -OutFile "C:\Program Files\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.msi"
            $cwagent_installer = "C:\Program Files\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent.msi"
            Start-Process -FilePath msiexec.exe -ArgumentList "/i $cwagent_installer /qn" -Wait
            Do {
              & "C:\Program Files\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent-ctl.ps1" -a fetch-config -m ec2 -s -c ssm:cloud-watch-config-windows
            } Until ((Get-Service -Name "AmazonCloudWatchAgent" | Where-Object {$_.Status -eq "Running"}) -or ((Get-Date) -gt $endTime))
          }

          $S3_BUCKET = "ec2-image-builder-nomis20220314103938567000000001"

          # Download Java exe from S3 Bucket
          Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/jre-6u33-windows-i586.exe -File C:\jumpserver-software\jre-6u33-windows-i586.exe

          # Install Java
          Start-Process -Wait -Verbose -FilePath "C:\jumpserver-software\jre-6u33-windows-i586.exe" -ArgumentList "/s", "/L C:\jumpserver-software\jre-install.log"

          # Set JAVA_HOME environment variable
          [System.Environment]::SetEnvironmentVariable("JAVA_HOME", "C:\Program Files (x86)\Java\jre6", [System.EnvironmentVariableTarget]::Machine)

          # Add Java to PATH environment variable
          [System.Environment]::SetEnvironmentVariable("Path", $env:Path + ";%JAVA_HOME%\bin", [System.EnvironmentVariableTarget]::Machine)

          # Copy deployment config files
          $deployment_folder = "C:\Windows\Sun\Java\Deployment"
          New-Item -Path $deployment_folder -ItemType Directory -Force
          Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/deployment.config -File $deployment_folder\deployment.config
          Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/deployment.properties -File $deployment_folder\deployment.properties
          Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/trusted.certs -File $deployment_folder\trusted.certs

          # Prevent Java update check
          $javaPath = "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Run"
          $valueName = "SunJavaUpdateSched"

          $properties = Get-ItemProperty -Path $javaPath

          if ($properties.PSObject.Properties.Name -contains $valueName) {
            Remove-ItemProperty -Path $javaPath -Name $valueName -Force
          }

          ######## EDGE GLOBAL CHANGES ########
          
          $reg_path = "HKLM:\SOFTWARE\Policies\Microsoft\Edge"
          
          # Turn off Edge first run experience
          New-Item -Path $reg_path -Force
          New-ItemProperty -Path $reg_path -Name HideFirstRunExperience -Value 1 -PropertyType DWORD -Force

          # Turn on Edge IE Mode using reg_path from previous step
          New-ItemProperty -Path $reg_path -Name InternetExplorerIntegrationLevel -Value 1 -PropertyType DWORD -Force

          # Allow popups for .justice.gov.uk urls
          $reg_path = "HKLM:\SOFTWARE\Policies\Microsoft\Edge\PopupsAllowedForUrls"
          New-Item -Path $reg_path -Force
          New-ItemProperty -Path $reg_path -Name 1 -Value "[*.]justice.gov.uk" -PropertyType String -Force

          ######## IE COMPATIBILITY MODE SITE LIST ########

          $ie_compatibility_mode_site_list = @(
              "t1-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t1-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t1-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t1-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t1-cn.hmpp-azdt.justice.gov.uk:7777/forms/frmservlet?config=tag"
              "t1-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t1.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t1.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t2-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t2-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t2-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t2-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t2-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t2.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t2.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-nomis-web-a.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-nomis-web-a.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-nomis-web-b.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-nomis-web-b.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-cn.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
              "t3-cn-ha.hmpp-azdt.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t3.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c-t3.test.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "preprod-nomis-web-a.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "preprod-nomis-web-a.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "preprod-nomis-web-b.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "preprod-nomis-web-b.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.pp-nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.preproduction.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.preproduction.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "prod-nomis-web-a.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "prod-nomis-web-a.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "prod-nomis-web-b.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "prod-nomis-web-b.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.production.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"
              "c.production.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
              "c.nomis.service.justice.gov.uk/forms/frmservlet?config=tag"
          )

          $compatibility_site_list_path = "C:\\compatibility_site_list.xml"

          $xmlDoc = New-Object System.Xml.XmlDocument
          $root = $xmlDoc.CreateElement("site-list")
          $root.SetAttribute('version', 1)
          $xmlDoc.AppendChild($root)

          $created_byElement = $xmlDoc.CreateElement("created-by")

          $toolElement = $xmlDoc.CreateElement("tool")
          $versionElement = $xmlDoc.CreateElement("version")
          $date_createdElement = $xmlDoc.CreateElement("date_created")
          $toolElement.InnerText = "EMIESiteListManager"
          $versionElement.InnerText = "10.0.0.0"
          $date_createdElement.InnerText = $(Get-Date -Format "MM/dd/yyyy hh:mm:ss")
          $created_byElement.AppendChild($toolElement)
          $created_byElement.AppendChild($versionElement)
          $created_byElement.AppendChild($date_createdElement)
          $root.AppendChild($created_byElement)

          foreach ($site in $ie_compatibility_mode_site_list) {
            $siteElement = $xmlDoc.CreateElement("site")
            $siteElement.SetAttribute('url', $site)
            $compatModeElement = $xmlDoc.CreateElement("compat-mode")
            $openInElement = $xmlDoc.CreateElement("open-in")
            $openInElement.SetAttribute('allow-redirect', 'true')
            $compatModeElement.InnerText = "Default"
            $openInElement.InnerText = "IE11"
            $siteElement.AppendChild($compatModeElement)
            $siteElement.AppendChild($openInElement)
            $root.AppendChild($siteElement)
          }

          $xmlDoc.Save($compatibility_site_list_path)

          # Add compatibility list to registry
          New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Edge" -Name InternetExplorerIntegrationSiteList -Value $compatibility_site_list_path -PropertyType String -Force

          ######## CREATE DOMAIN ALLOW LIST FOR EDGE ########

          # The jumpserver is using IE Enhanced Security so each domain needs to be explicitly added to the following
          # - Registry to allow certain domains to Bypass Enhanced Security (see below)  
          # - Trusted Sites - HKCU, HKLM does not apply since the machine is not on the domain 
          # NOTE: https:// traffic ONLY is allowed, these settings are external to this environment and are not managed by this script

          $domains = @(
            "*.nomis.hmpps-development.modernisation-platform.justice.gov.uk"
            "*.nomis.hmpps-test.modernisation-platform.justice.gov.uk"
            "*.nomis.hmpps-preproduction.modernisation-platform.justice.gov.uk"
            "*.nomis.hmpps-production.modernisation-platform.justice.gov.uk"
            "*.nomis.service.justice.gov.uk"
            "*.nomis.az.justice.gov.uk"
            "*.hmpp-azdt.justice.gov.uk"
          )

          $registryPath = "HKLM:\SOFTWARE\Policies\Microsoft\Edge\EnhanceSecurityModeBypassListDomains"

          # Ensure the registry path exists
          if (!(Test-Path $registryPath)) {
            New-Item -Path $registryPath -Force
          }

          # Add each domain to the exclusion list for IE Enhanced Security
          # NOTE: subdomains are automatically included
          for ($i = 0; $i -lt $domains.Length; $i++) {
            $index = $i + 1
            $value = $domains[$i] -replace '^\*\.', '' 

            New-Item -Path "$registryPath\$index" -Force    

            New-ItemProperty -Path "$registryPath\$index" -Name "(Default)" -Value $value -PropertyType String -Force
          
          }

          # Add each domain to the trusted sites list
          $paths = @(
              "HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains"
          )

          foreach($path in $paths){
            $domains | ForEach-Object {
                New-Item -Path $path\$_ -Force
                New-ItemProperty -Path $path\$_ -Name https -Value 2 -PropertyType DWORD -Force
            }
          }

          # Use Local Machine settings for Internet Security Settings
          $reg_path = "HKLM:\Software\Policies\Microsoft\Windows\CurrentVersion\Internet Settings"

          if (!(Test-Path $reg_path)) {
            New-Item -Path $reg_path -Force
          }
          
          New-ItemProperty -Path $reg_path -Name Security_HKLM_only -Value 1 -PropertyType DWORD -Force

          ######## INSTALL SQL DEVELOPER ########

          # Download SQL Developer
          Read-S3Object -BucketName $S3_BUCKET -Key jumpserver-software/sqldeveloper-22.2.1.234.1810-x64.zip -File C:\jumpserver-software\sqldeveloper-22.2.1.234.1810-x64.zip

          # Extract SQL Developer - there is no installer for this application
          Expand-Archive -Path C:\jumpserver-software\sqldeveloper-22.2.1.234.1810-x64.zip -DestinationPath "C:\Program Files\Oracle"

          # Create a desktop shortcut
          $shortcut = New-Object -ComObject WScript.Shell
          $shortcut_link = $shortcut.CreateShortcut("C:\Users\Public\Desktop\SQL Developer.lnk")
          $shortcut_link.TargetPath = "C:\Program Files\Oracle\sqldeveloper\sqldeveloper.exe"
          $shortcut_link.Save()

          ######## INSTALL LIBREOFFICE ########

          choco install -y libreoffice-still

          ######## ADD DESKTOP SHORTCUTS FOR T1-3 ########

          for ($i = 1; $i -le 3; $i++) {

            $url = "https://c-t$i.test.nomis.az.justice.gov.uk/forms/frmservlet?config=tag"

            $shortcut = New-Object -ComObject WScript.Shell
            $destination = $shortcut.SpecialFolders.Item("AllUsersDesktop")
            $source_path = Join-Path -Path $destination -ChildPath "\\C-T$i-Nomis.url"
            $sourc = $shortcut.CreateShortcut($source_path)
            $sourc.TargetPath = $url

            $sourc.Save()       
          
          }
          
          ######## ADD DESKTOP SHORTCUTS FOR PRODUCTION AND PREPRODUCTION ########
          # NOTE: Not yet implemented, hoping to add these later based on the environment the jumpserver is deployed to