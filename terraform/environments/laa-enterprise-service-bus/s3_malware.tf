# Example configuration provided as a reference for setting up GuardDuty Malware Protection - modify as needed.

# GuardDuty Malware Protection Plan
resource "aws_guardduty_malware_protection_plan" "malware_protection_plan" {

  # Use a statically-keyed map so Terraform knows the instance keys at plan time.
  # Values (bucket IDs) may be unknown until apply, which is acceptable; only keys must be known.
  for_each = {
    lambda_layer_dependencies = aws_s3_bucket.lambda_layer_dependencies.id
    data                       = aws_s3_bucket.data.id
    access_logs                = aws_s3_bucket.access_logs.id
  }

  role = data.aws_iam_role.guardduty_malware_protection_role.arn

  protected_resource {
    s3_bucket {
      bucket_name = each.value
    }
  }

  actions {
    tagging {
      status = "ENABLED"
    }
  }

  tags = merge(
    local.tags,
    { "Name" = "GuardDutyMalwareProtectionPlan-${each.key}" }
  )
}

data "aws_iam_role" "guardduty_malware_protection_role" {
  name = "GuardDutyS3MalwareProtectionRole"
}