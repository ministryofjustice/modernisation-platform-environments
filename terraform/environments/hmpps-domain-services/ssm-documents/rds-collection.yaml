---
schemaVersion: "2.2"
description: "SSM Document for configuring an RDS collection"
parameters:
  domainUsername:
    type: "String"
    description: "Username with domain join permissions"
  domainPassword:
    type: "String"
    description: "Password for the domain join user (NOTE: Do not use a password containing quotes)"
  rdsHostname:
    type: "String"
    description: "RDS instance to install  the collection on"
mainSteps:
  - name: ConfigureRdsCollection
    action: aws:runPowerShellScript
    precondition:
      StringEquals:
        - platformType
        - Windows
    inputs:
      runCommand:
        - |
          $username = "{{domainUsername}}@AZURE.NOMS.ROOT"
          $password =  ConvertTo-SecureString "{{domainPassword}}" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential -ArgumentList ($username, $password)
          
          Invoke-Command -ComputerName {{rdsHostname}}.azure.noms.root  -credential $credential -scriptblock {
            $CollectionName = "Test1"
            $CollectionDescription = "Test1"
            $CollectionSessionHost = @("examplesessionhost1.azure.noms.root")
            $CollectionUserGroup = @("Azure\Domain Users")
            $RDSCORE =  "$env:computername.azure.noms.root"
            New-RDSessionCollection -CollectionName $CollectionName -SessionHost $CollectionSessionHost -ConnectionBroker $RDSCORE  -CollectionDescription $CollectionDescription
            Set-RDSessionCollectionConfiguration -CollectionName $CollectionName -ConnectionBroker $RDSCORE -UserGroup $CollectionUserGroup
          }