---
schemaVersion: "2.2"
description: "SSM Document for configuring an RDS collection"
mainSteps:
  - name: DeployRDS
    action: aws:runPowerShellScript
    precondition:
      StringEquals:
        - platformType
        - Windows
    inputs:
      runCommand:
        - |
          $username = "username@AZURE.NOMS.ROOT"
          $password =  ConvertTo-SecureString "password" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential -ArgumentList ($username, $password)
          
          Invoke-Command -ComputerName rdscore4.azure.noms.root  -credential $credential -scriptblock {
            $CollectionName = "Test1"
            $CollectionDescription = "Test1"
            $CollectionSessionHost = @("rdsshaws3.azure.noms.root")
            $CollectionUserGroup = @("Azure\Domain Users")
            $RDSCORE =  "$env:computername.azure.noms.root"
            New-RDSessionCollection -CollectionName $CollectionName -SessionHost $CollectionSessionHost -ConnectionBroker $RDSCORE  -CollectionDescription $CollectionDescription
            Set-RDSessionCollectionConfiguration -CollectionName $CollectionName -ConnectionBroker $RDSCORE -UserGroup $CollectionUserGroup
          }