---
schemaVersion: "2.2"
description: "SSM Document for deploying a quick-start single server RDS deployment"
parameters:
  domainUsername:
    type: "String"
    description: "Username with domain join permissions"
  domainPassword:
    type: "String"
    description: "Password for the domain join user (NOTE: Do not use a password containing quotes)"
  rdsCoreHostname:
    type: "String"
    description: "Hostname of the instance that RDS will be deployed on"
  rdsGatewayHostname:
    type: "String"
    description: "Hostname of the gateway for the RDS deployment"
mainSteps:
  - name: ConfigureSingleServerRdsDeployment
    action: aws:runPowerShellScript
    precondition:
      StringEquals:
        - platformType
        - Windows
    inputs:
      runCommand:
        - |
          $username = "{{domainUsername}}@AZURE.NOMS.ROOT"
          $password =  ConvertTo-SecureString "{{domainPassword}}" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential -ArgumentList ($username, $password)
          
          Invoke-Command -ComputerName {{rdsCoreHostname}}.azure.noms.root  -credential $credential -scriptblock {
            $RDGWFQDN = "{{rdsGatewayHostname}}.hmpps-domain-services.hmpps-development.modernisation-platform.service.justice.gov.uk"
            $RDSH = @("sessionhostexample1.azure.noms.root")
            $RDSCORE = "$env:computername.azure.noms.root"

            Add-WindowsFeature -Name RDS-Connection-Broker -IncludeManagementTools
            Add-WindowsFeature -Name RDS-Licensing, RDS-Licensing-UI
            Add-WindowsFeature -Name RDS-Web-Access -IncludeManagementTools

            # Create core RDS deployment
            New-RDSessionDeployment -ConnectionBroker $RDSCORE -SessionHost $RDSH -WebAccessServer $RDSCORE

            # Licensing configuration (activate and install licenses via UI)
            Add-RDServer -Server $RDSCORE -Role RDS-Licensing -ConnectionBroker $RDSCORE
            Set-RDLicenseConfiguration -Mode PerUser -LicenseServer $RDSCORE -ConnectionBroker $RDSCORE -Force
            
            # Gateway created on this instance but is unused
            Add-RDServer -Server $RDSCORE -Role RDS-Gateway -ConnectionBroker $RDSCORE -GatewayExternalFqdn $RDGWFQDN
          }