# This is an EC2Launch V2 type user-data script
# https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2launch-v2-settings.html#ec2launch-v2-task-configuration
# See C:\ProgramData\Amazon\EC2Launch\log for logs
version: 1.0
tasks:
  - task: executeScript
    inputs:
      - frequency: once
        type: powershell
        runAs: admin
        content: |
          # Set time to local and locale
          # $ErrorActionPreference = "Stop" # set all errors to terminate script

          Set-TimeZone "GMT Standard Time"
          Set-WinSystemLocale "en-GB"        
      - frequency: once
        type: powershell
        runAs: admin
        content: |
          # Install apps
          # $ErrorActionPreference = "Stop" # set all errors to terminate script

          $apps = @(
            "firefox"
            "libreoffice-still"
            "notepadplusplus.install"
            "putty.install"
            "winscp.install"
            "postman"
            "vcredist140" # dependency for wireshark
            "wireshark"
          )

          foreach ($app in $apps) {
            choco install $app -y
          }
      - frequency: once
        type: powershell
        runAs: admin
        content: |
          # Download SQL Developer
          $S3_BUCKET = mod-platform-image-artefact-bucket20230203091453221500000001

          Read-S3Object -BucketName $S3_BUCKET -Key hmpps/sqldeveloper/sqldeveloper-22.2.1.234.1810-x64.zip -File C:\management-server-software\sqldeveloper-22.2.1.234.1810-x64.zip

          # Extract SQL Developer - there is no installer for this application
          Expand-Archive -Path C:\management-server-software\sqldeveloper-22.2.1.234.1810-x64.zip -DestinationPath "C:\Program Files\Oracle"

          # Create a desktop shortcut
          $shortcut = New-Object -ComObject WScript.Shell
          $shortcut_link = $shortcut.CreateShortcut("C:\Users\Public\Desktop\SQL Developer.lnk")
          $shortcut_link.TargetPath = "C:\Program Files\Oracle\sqldeveloper\sqldeveloper.exe"
          $shortcut_link.Save()          
