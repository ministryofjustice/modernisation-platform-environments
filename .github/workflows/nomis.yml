---
name: nomis
on:
  push:
    branches:
      - main
    paths:
      - 'terraform/environments/nomis/**'
      - '.github/workflows/nomis.yml'

  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]
    paths:
      - 'terraform/environments/nomis/**'
      - '.github/workflows/nomis.yml'

  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.DSO_GITHUB_AUTOMATION_PAT }}
  TF_IN_AUTOMATION: true
  TF_VAR_BRANCH_NAME: ${{ github.event_name == 'pull_request' && 'main' || (github.head_ref || github.ref_name) }}
  TF_VAR_GH_ACTOR_NAME: ${{ github.actor}}
  AWS_REGION: "eu-west-2"
  ENVIRONMENT_MANAGEMENT: ${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENTS }}

permissions:
  id-token: write  # This is required for requesting the JWT
  contents: read  # This is required for actions/checkout

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.init.outputs.matrix }}
    steps:
      - name: Init
        id: init
        run: |
          if [[ ${{ github.ref }} != 'refs/head/main' ]]; then
            matrix=$(cat << EOF
            {
              "include": [{
                "target": "development",
                "action": "plan_apply"
              }, {
                "target": "test",
                "action": "plan_apply"
              }, {
                "target": "preproduction",
                "action": "plan"
              }, {
                "target": "production",
                "action": "plan"
              }]
            }
          EOF
          )
          else
            matrix=$(cat << EOF
            {
              "include": [{
                "target": "development",
                "action": "plan_apply"
              }, {
                "target": "test",
                "action": "plan_apply"
              }, {
                "target": "preproduction",
                "action": "plan_apply"
              }, {
                "target": "production",
                "action": "plan_apply"
              }]
            }
          EOF
          )
          fi
          echo 'matrix<<EOF' >> $GITHUB_ENV
          echo "${matrix}" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV          
          echo "${matrix}"

      - name: Debug
        run: |
          echo "${{ steps.init.outputs.matrix }}"

  terraform:
    needs: init
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.init.outputs.matrix) }}
    uses: ministryofjustice/modernisation-platform-environments/.github/workflows/reusable_terraform_plan_apply.yml@nomis/DSOS-1519/pipeline-improvements
    with:
      application: "${{ github.workflow }}"
      environment: "${{ matrix.target }}"
      action: "${{ matrix.action }}"
    secrets:
      modernisation_platform_environments: "${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENTS }}"
      pipeline_github_token: "${{ secrets.DSO_GITHUB_AUTOMATION_PAT }}"
