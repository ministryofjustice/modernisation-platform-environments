---
name: nomis
on:
  push:
    branches: 
      - main
    paths:
      - 'terraform/environments/nomis/**'
      - '.github/workflows/nomis.yml'
  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]
    paths:
      - 'terraform/environments/nomis/**'
      - '.github/workflows/nomis.yml'
  workflow_dispatch:
  # repository_dispatch:
env:
  AWS_ACCESS_KEY_ID:  ${{ secrets.NOMIS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY:  ${{ secrets.NOMIS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.NOMIS_SESSION_TOKEN }}
defaults:
  run:
    shell: bash

jobs:
  # this job runs on PR when packer files changed
  packer-validate:
    name: Packer Validate
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    defaults:
      run:
        shell: bash
        working-directory: "terraform/environments/nomis/packer/image1"
    environment:
      name: packer-build
    steps:     
    - name: Checkout the code
      uses: actions/checkout@v2.3.4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-2

    # - name: Initialise Packer
    #   uses: hashicorp/packer-github-actions@master
    #   with:
    #     command: init
    #     target: terraform/environments/nomis/packer/${{ matrix.image }} 

    # - name: Validate Packer template
    #   uses: hashicorp/packer-github-actions@master
    #   with:
    #     command: validate
    #     target: terraform/environments/nomis/packer/${{ matrix.image }}

    # - name: Inspect Packer template
    #   uses: hashicorp/packer-github-actions@master
    #   with:
    #     command: inspect
    #     target: terraform/environments/nomis/packer/${{ matrix.image }} 

    - name: Setup Packer
      uses: hashicorp-contrib/setup-packer@v1.0.0

    - name: Initialise Packer
      run: packer init .

    - name: Validate Packer template
      run: packer validate .

    - name: Inspect Packer template
      run: packer inspect . | tee comment.txt

    - name: Post PR comment 
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        # recreate: true # this needs changing
        path: terraform/environments/nomis/packer/image2/comment.txt

  packer-build:
    name: Packer Build ${{ matrix.image }}
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    defaults:
      run:
        shell: bash
        working-directory: "terraform/environments/nomis/packer/image2"
    environment:
      name: packer-build
    steps:
      - name: Checkout the code
        uses: actions/checkout@v2.3.4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - name: Setup Packer
        uses: hashicorp-contrib/setup-packer@v1.0.0

      - name: Initialise Packer
        run: packer init .

      - name: Build Packer Image
        run: packer build .