# .github/workflows/ami_cleanup.yml
name: Cloud Cleanup (AMI & EBS)

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application folder name (e.g. example)'
        required: true
        type: string
      environments:
        description: 'Comma-separated list of environments (e.g. development,production)'
        required: true
        type: string
      cleanup_type:
        description: 'Which cleanup to run (ami, ebs, both)'
        required: true
        default: 'both'
        type: choice
        options: [ami, ebs, both]
      ami_cleanup_sh_args:
        description: 'Arguments passed to ami_cleanup.sh'
        required: false
        default: "-c -m 3"
        type: string
      ebs_age_in_months:
        description: 'Delete unattached EBS volumes older than this many months'
        required: false
        default: "1"
        type: string
      confirm_delete:
        description: 'Set to true to perform deletion. false = preview only.'
        required: true
        default: false
        type: boolean
  push:
    branches:
      - feature-11321-identifying-snapshots-to-be-deleted

permissions:
  id-token: write
  contents: read

env:
  APPLICATION: ${{ github.event.inputs.application || 'example' }}
  ENVIRONMENTS: ${{ github.event.inputs.environments || 'development' }}
  AMI_ARGS: ${{ github.event.inputs.ami_cleanup_sh_args || '-c -m 3' }}
  EBS_MONTHS: ${{ github.event.inputs.ebs_age_in_months || '1' }}

jobs:
  build-matrix:
    name: Build Account Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.strategy.outputs.matrix }}
    steps:
      - name: Build strategy matrix
        id: strategy
        run: |
          set -euo pipefail
          app="${APPLICATION}"
          envs_str="${ENVIRONMENTS}"
          IFS=', ' read -r -a envs <<< "$envs_str"
          echo "Application: $app"
          echo "Environments: ${envs[@]}"
          echo '{"include":[' > matrix.json
          for env in "${envs[@]}"; do
            acc="${app}-${env}"
            echo "{\"account_name\":\"$acc\"}," >> matrix.json
          done
          sed -i '$ s/,$//' matrix.json
          echo ']}' >> matrix.json
          matrix=$(cat matrix.json)
          echo 'matrix<<EOF' >> $GITHUB_OUTPUT
          echo "${matrix}" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

  fetch-secrets:
    name: Fetch ENV management secrets
    uses: ministryofjustice/modernisation-platform-github-actions/.github/workflows/aws-secrets-management.yml@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c
    secrets:
      MODERNISATION_PLATFORM_ACCOUNT_NUMBER: ${{ secrets.MODERNISATION_PLATFORM_ACCOUNT_ID }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}

  # -------------------------
  # PREVIEW (Dry-Run) STAGE
  # - Runs on push for BOTH AMI & EBS
  # - Runs on workflow_dispatch when confirm_delete == false
  # -------------------------
  preview:
    name: Preview Deletions (Dry-Run)
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets]
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_delete == 'false') }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Decrypt Secrets (ENVIRONMENT_MANAGEMENT)
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          github_ci_user_environments_repo_pat: ${{ needs.fetch-secrets.outputs.github_ci_user_environments_repo_pat }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Resolve AWS Account Number
        run: |
          set -euo pipefail
          ACCOUNT_NAME="${{ matrix.account_name }}"
          ACCOUNT_NUMBER=$(jq -r -e --arg account_name "${ACCOUNT_NAME}" '.account_ids[$account_name]' <<< "$ENVIRONMENT_MANAGEMENT")
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=${ACCOUNT_NUMBER}" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: "arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions"
          role-session-name: "cleanup-preview-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: AMI Preview (dry-run)
        if: ${{ github.event_name == 'push' || github.event.inputs.cleanup_type == 'ami' || github.event.inputs.cleanup_type == 'both' }}
        id: ami_preview
        run: |
          set -euo pipefail
          app="${APPLICATION}"
          args="${AMI_ARGS}"
          echo "[PREVIEW] Collecting AMI delete candidates (dry-run)"
          scripts/ami_cleanup.sh -a "$app" -s ami_commands.sh $args -d delete
          AMI_COUNT="$(grep -c '^aws ec2 deregister-image' ami_commands.sh || true)"
          echo "ami_count=${AMI_COUNT}" >> "$GITHUB_OUTPUT"
          [[ -f ami_candidates.csv ]] || touch ami_candidates.csv
          [[ -f ami_commands.sh ]] || touch ami_commands.sh
          {
            echo "### AMI Preview — ${{ matrix.account_name }}"
            echo ""
            echo "- Candidates: ${AMI_COUNT}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload AMI Preview Artifacts
        if: ${{ (github.event_name == 'push' || github.event.inputs.cleanup_type == 'ami' || github.event.inputs.cleanup_type == 'both') && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ami-preview-${{ matrix.account_name }}
          path: |
            ami_candidates.csv
            ami_commands.sh
          if-no-files-found: warn

      - name: EBS Preview (dry-run)
        if: ${{ github.event_name == 'push' || github.event.inputs.cleanup_type == 'ebs' || github.event.inputs.cleanup_type == 'both' }}
        id: ebs_preview
        run: |
          set -euo pipefail
          months="${EBS_MONTHS}"
          echo "[PREVIEW] Listing unattached EBS volumes older than ${months} month(s) (dry-run only; no deletion)"
          scripts/ebs_cleanup.sh -m "$months" unattached | tee ebs_candidates.txt
          EBS_COUNT="$(grep -Eo 'vol-[0-9a-f]+' ebs_candidates.txt | wc -l | tr -d ' ')"
          echo "ebs_count=${EBS_COUNT}" >> "$GITHUB_OUTPUT"
          [[ -f ebs_candidates.txt ]] || touch ebs_candidates.txt
          {
            echo "### EBS Preview — ${{ matrix.account_name }}"
            echo ""
            echo "- Unattached volumes slated by age filter: ${EBS_COUNT}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload EBS Preview Artifacts
        if: ${{ (github.event_name == 'push' || github.event.inputs.cleanup_type == 'ebs' || github.event.inputs.cleanup_type == 'both') && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ebs-preview-${{ matrix.account_name }}
          path: ebs_candidates.txt
          if-no-files-found: warn

  # -------------------------
  # LIVE (Deletion) STAGE — only via manual dispatch with confirm_delete=true
  # -------------------------
  ami-delete:
    name: AMI Delete (Live)
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets]
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.cleanup_type == 'ami' || github.event.inputs.cleanup_type == 'both') && github.event.inputs.confirm_delete == 'true' }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Decrypt Secrets (ENVIRONMENT_MANAGEMENT)
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          github_ci_user_environments_repo_pat: ${{ needs.fetch-secrets.outputs.github_ci_user_environments_repo_pat }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Resolve AWS Account Number
        run: |
          set -euo pipefail
          ACCOUNT_NAME="${{ matrix.account_name }}"
          ACCOUNT_NUMBER=$(jq -r -e --arg account_name "${ACCOUNT_NAME}" '.account_ids[$account_name]' <<< "$ENVIRONMENT_MANAGEMENT")
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=${ACCOUNT_NUMBER}" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: "arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions"
          role-session-name: "ami-delete-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Recompute & Delete AMIs (Live)
        run: |
          set -euo pipefail
          app="${APPLICATION}"
          args="${AMI_ARGS}"
          echo "[LIVE] Collecting candidates and deregistering (if any)"
          scripts/ami_cleanup.sh -a "$app" -s ami_commands.sh $args delete
          [[ -f ami_candidates.csv ]] || touch ami_candidates.csv
          [[ -f ami_commands.sh ]] || touch ami_commands.sh

      - name: Upload AMI Live Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ami-live-${{ matrix.account_name }}
          path: |
            ami_candidates.csv
            ami_commands.sh
          if-no-files-found: warn

  ebs-delete:
    name: EBS Delete (Live)
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets]
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.cleanup_type == 'ebs' || github.event.inputs.cleanup_type == 'both') && github.event.inputs.confirm_delete == 'true' }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: chmod +x scripts/*.sh

      - name: Decrypt Secrets (ENVIRONMENT_MANAGEMENT)
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@4eceb2a416a197e91dc557c2ef0b5dd9afe29e0c
        with:
          environment_management: ${{ needs.fetch-secrets.outputs.environment_management }}
          github_ci_user_environments_repo_pat: ${{ needs.fetch-secrets.outputs.github_ci_user_environments_repo_pat }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

      - name: Resolve AWS Account Number
        run: |
          set -euo pipefail
          ACCOUNT_NAME="${{ matrix.account_name }}"
          ACCOUNT_NUMBER=$(jq -r -e --arg account_name "${ACCOUNT_NAME}" '.account_ids[$account_name]' <<< "$ENVIRONMENT_MANAGEMENT")
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=${ACCOUNT_NUMBER}" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: "arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions"
          role-session-name: "ebs-delete-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Delete EBS Volumes (Live)
        run: |
          set -euo pipefail
          months="${EBS_MONTHS}"
          echo "[LIVE] Deleting unattached EBS volumes older than ${months} month(s)"
          scripts/ebs_cleanup.sh -m "$months" delete | tee ebs_delete_log.txt
          [[ -f ebs_delete_log.txt ]] || touch ebs_delete_log.txt

      - name: Upload EBS Live Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ebs-live-${{ matrix.account_name }}
          path: ebs_delete_log.txt
          if-no-files-found: warn
