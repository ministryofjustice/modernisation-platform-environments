name: Cloud Cleanup (AMI & EBS)

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application folder name (e.g. nomis)'
        required: true
        type: string
      environments:
        description: 'Comma-separated list of environments (e.g. development,production)'
        required: true
        type: string
      cleanup_type:
        description: 'Which cleanup to run (ami, ebs, both)'
        required: true
        default: 'both'
        type: choice
        options: [ami, ebs, both]
      ami_cleanup_sh_args:
        description: 'Arguments passed to ami_cleanup.sh'
        required: false
        default: "-c -m 3"
        type: string
      ebs_age_in_months:
        description: 'Delete unattached EBS volumes older than this many months'
        required: false
        default: "1"
        type: string
      dryrun:
        description: 'Dry run mode'
        required: true
        default: true
        type: boolean
  push:
    branches:
      - feature-11321-identifying-snapshots-to-be-deleted

permissions:
  id-token: write
  contents: read

# ===== TEMP DRY-RUN OVERRIDE (FOR PUSH TESTING) =====
# These env defaults make push-triggered runs behave like a DRY RUN.
# Remove this whole block after testing.
env:
  APPLICATION: ${{ github.event.inputs.application || 'nomis' }}
  ENVIRONMENTS: ${{ github.event.inputs.environments || 'development' }}
  CLEANUP_TYPE: ${{ github.event.inputs.cleanup_type || 'both' }}
  AMI_ARGS: ${{ github.event.inputs.ami_cleanup_sh_args || '-c -m 3' }}
  EBS_MONTHS: ${{ github.event.inputs.ebs_age_in_months || '1' }}
  DRYRUN: ${{ (github.event.inputs.dryrun != '' && github.event.inputs.dryrun) || 'true' }}
# ===== END TEMP DRY-RUN OVERRIDE =====

jobs:
  build-matrix:
    name: Build Account Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.strategy.outputs.matrix }}
    steps:
      - name: Build strategy matrix
        id: strategy
        run: |
          set -euo pipefail
          app="${APPLICATION}"
          envs_str="${ENVIRONMENTS}"
          IFS=', ' read -r -a envs <<< "$envs_str"
          echo "Application: $app"
          echo "Environments: ${envs[@]}"
          echo '{"include":[' > matrix.json
          for env in "${envs[@]}"; do
            acc="${app}-${env}"
            echo "{\"account_name\":\"$acc\"}," >> matrix.json
          done
          sed -i '$ s/,$//' matrix.json
          echo ']}' >> matrix.json
          matrix=$(cat matrix.json)
          echo 'matrix<<EOF' >> $GITHUB_OUTPUT
          echo "${matrix}" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

  ami-cleanup:
    name: AMI Cleanup
    runs-on: ubuntu-latest
    needs: build-matrix
    # Manual: respect inputs.cleanup_type; Push: run (dry-run via env)
    if: ${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.cleanup_type == 'ami' || github.event.inputs.cleanup_type == 'both')) || (github.event_name == 'push') }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Get Account Details
        id: account
        env:
          MP_JSON: ${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT }}
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          if [[ -z "${MP_JSON:-}" ]]; then
            echo "Missing secret: MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT" >&2
            exit 1
          fi
          account_name="${{ matrix.account_name }}"
          account_id=$(printf '%s' "$MP_JSON" | jq -r --arg k "$account_name" '.account_ids[$k]')
          if [[ -z "$account_id" || "$account_id" == "null" ]]; then
            echo "Account id not found for key: ${account_name}" >&2
            printf '%s\n' "$MP_JSON" | jq -r '.account_ids | keys[]' | sed 's/^/Available key: /'
            exit 1
          fi
          echo "role_arn=arn:aws:iam::${account_id}:role/modernisation-platform-oidc-cicd" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: "${{ steps.account.outputs.role_arn }}"
          role-session-name: "ami-cleanup-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Checkout Repo
        uses: actions/checkout@v4

      # SAFE: do NOT pass 'delete' when DRYRUN is true
      - name: Run AMI Cleanup (Collect)
        run: |
          set -euo pipefail
          app="${APPLICATION}"
          args="${AMI_ARGS}"
          if [[ "${DRYRUN}" == 'true' ]]; then
            echo "[DRY RUN] Collecting AMI delete candidates (no delete arg passed)"
            scripts/ami_cleanup.sh -a "$app" -s ami_commands.sh $args
          else
            echo "[LIVE] Collecting and preparing deletes"
            scripts/ami_cleanup.sh -a "$app" -s ami_commands.sh $args delete
          fi

      # Only execute on manual runs with dryrun=false
      - name: Execute AMI Deregistration (if not dryrun)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dryrun == 'false' }}
        run: |
            set -euo pipefail
            if [[ -f ami_commands.sh ]]; then
              grep 'aws ec2 deregister-image' ami_commands.sh | while read -r cmd; do
                echo "Executing: $cmd"
                eval "$cmd"
              done
            else
              echo "No AMI commands to execute."
            fi

      - name: Upload AMI Commands (Dry-Run Preview)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ami-commands-${{ matrix.account_name }}
          path: ami_commands.sh
          if-no-files-found: ignore

  ebs-cleanup:
    name: EBS Cleanup
    runs-on: ubuntu-latest
    needs: build-matrix
    # Manual: respect inputs.cleanup_type; Push: run (dry-run via env)
    if: ${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.cleanup_type == 'ebs' || github.event.inputs.cleanup_type == 'both')) || (github.event_name == 'push') }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Get Account Details
        id: account
        env:
          MP_JSON: ${{ secrets.MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT }}
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          if [[ -z "${MP_JSON:-}" ]]; then
            echo "Missing secret: MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT" >&2
            exit 1
          fi
          account_name="${{ matrix.account_name }}"
          account_id=$(printf '%s' "$MP_JSON" | jq -r --arg k "$account_name" '.account_ids[$k]')
          if [[ -z "$account_id" || "$account_id" == "null" ]]; then
            echo "Account id not found for key: ${account_name}" >&2
            printf '%s\n' "$MP_JSON" | jq -r '.account_ids | keys[]' | sed 's/^/Available key: /'
            exit 1
          fi
          echo "role_arn=arn:aws:iam::${account_id}:role/modernisation-platform-oidc-cicd" >> "$GITHUB_OUTPUT"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502
        with:
          role-to-assume: "${{ steps.account.outputs.role_arn }}"
          role-session-name: "ebs-cleanup-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Run EBS Cleanup
        run: |
          set -euo pipefail
          months="${EBS_MONTHS}"
          if [[ "${DRYRUN}" == 'true' ]]; then
            echo "[DRY RUN] Listing unattached EBS volumes (no deletion)"
            scripts/ebs_cleanup.sh -m "$months" unattached
          else
            echo "[LIVE] Deleting unattached EBS volumes"
            scripts/ebs_cleanup.sh -m "$months" delete
          fi
