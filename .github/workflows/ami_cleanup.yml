name: Cloud Cleanup (AMI & EBS)

on:
  workflow_dispatch:
    inputs:
      application:
        description: "Account/application name (e.g. cooker)"
        type: string
        required: true
        default: cooker
      environment:
        description: "Environment name"
        type: choice
        options: [development, test, preproduction, production]
        required: true
        default: development
      cleanup_type:
        description: "Which resources to act on"
        type: choice
        options: [ami, ebs, both]
        required: true
        default: both
      # NEW: enables 10-minute test flags in LIVE jobs
      live_test_mode:
        description: "Pass --test-mode --age-minutes 10 to LIVE jobs (dangerous outside testing!)"
        type: boolean
        required: true
        default: false

permissions:
  id-token: write
  contents: read
  actions: read

env:
  APPLICATION: ${{ inputs.application }}
  ENVIRONMENTS: ${{ inputs.environment }}
  AWS_REGION: eu-west-2
  AWS_DEFAULT_REGION: eu-west-2

jobs:
  build-matrix:
    name: Build Account Matrix
    runs-on: ubuntu-latest
    outputs:
      account_name: ${{ steps.mk.outputs.account_name }}
    steps:
      - uses: actions/checkout@v4
      - id: mk
        run: |
          echo "account_name=${APPLICATION}-${ENVIRONMENTS}" >> "$GITHUB_OUTPUT"

  fetch-secrets:
    name: Fetch ENV management secrets
    runs-on: ubuntu-latest
    needs: build-matrix
    outputs:
      environment_management: ${{ steps.dec.outputs.environment_management }}
      github_ci_user_environments_repo_pat: ${{ steps.dec.outputs.github_ci_user_environments_repo_pat }}
    steps:
      - uses: actions/checkout@v4
      - id: dec
        uses: ministryofjustice/modernisation-platform-github-actions/decrypt-secrets@v3.4.6
        with:
          environment_management: ${{ secrets.ENVIRONMENT_MANAGEMENT }}
          github_ci_user_environments_repo_pat: ${{ secrets.GITHUB_CI_USER_ENVIRONMENTS_REPO_PAT }}
          PASSPHRASE: ${{ secrets.PASSPHRASE }}

  preview:
    name: Preview Deletions (Dry-Run) (${{ needs.build-matrix.outputs.account_name }})
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets]
    steps:
      - uses: actions/checkout@v4

      - name: Resolve AWS Account Number
        id: acct
        run: |
          ACCOUNT_NUMBER=$(jq -r -e --arg n "${{ needs.build-matrix.outputs.account_name }}" '.account_ids[$n]' <<< '${{ needs.fetch-secrets.outputs.environment_management }}')
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=$ACCOUNT_NUMBER" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions
          role-session-name: cleanup-preview-${{ needs.build-matrix.outputs.account_name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Quick inventory (sanity)
        run: |
          set -euo pipefail
          echo "Matrix account name: ${{ needs.build-matrix.outputs.account_name }}"
          echo "Resolved account number: ${ACCOUNT_NUMBER}"
          echo "==== AWS STS Caller Identity ===="
          aws sts get-caller-identity
          echo "==== AWS Region (from config/env) ===="
          echo "aws configure get region => $(aws configure get region || true)"
          echo "AWS_REGION=$AWS_REGION AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION"
          echo "==== AMIs named 'cleanup-test*' (owners self) ===="
          aws ec2 describe-images --owners self \
            --filters Name=name,Values='cleanup-test*' \
            --query "Images[].{Id:ImageId,Name:Name,When:CreationDate}" \
            --output table || true
          echo "==== Unattached EBS volumes (available) â€” top 50 ===="
          aws ec2 describe-volumes --filters Name=status,Values=available \
            --query "Volumes[0:50].[VolumeId,CreateTime,State,Tags[?Key=='Name']|[0].Value]" \
            --output table || true

      - name: Set 10-minute test flags (preview only)
        run: |
          echo "AMI_TEST_FLAGS=--test-mode --age-minutes 10" >> $GITHUB_ENV
          echo "EBS_TEST_FLAGS=--test-mode --age-minutes 10" >> $GITHUB_ENV

      - name: AMI Preview (dry-run)
        if: ${{ inputs.cleanup_type == 'ami' || inputs.cleanup_type == 'both' }}
        env:
          AMI_ARGS: "-c -m 3"
        run: |
          set -euo pipefail
          echo "[PREVIEW] Scanning AMIs in ${AWS_REGION} (dry-run; no deletion)"
          echo "AMI_ARGS: ${AMI_ARGS}"
          echo "Effective AMI test flags: ${AMI_TEST_FLAGS}"
          scripts/ami_cleanup.sh ${AMI_TEST_FLAGS:-} ${AMI_ARGS} --region "${AWS_REGION}" --dry-run | tee /tmp/ami_preview.txt
          [[ -f ami_commands.sh ]] || touch ami_commands.sh

      - name: Upload AMI Preview Artifacts
        if: ${{ (inputs.cleanup_type == 'ami' || inputs.cleanup_type == 'both') }}
        uses: actions/upload-artifact@v4
        with:
          name: ami-preview-${{ needs.build-matrix.outputs.account_name }}
          path: |
            /tmp/ami_preview.txt
            ami_commands.sh

      - name: EBS Preview (dry-run)
        if: ${{ inputs.cleanup_type == 'ebs' || inputs.cleanup_type == 'both' }}
        env:
          EBS_MONTHS: 1
        run: |
          set -euo pipefail
          months="${EBS_MONTHS}"
          echo "[PREVIEW] Listing unattached EBS volumes older than 1 month(s) (dry-run only; no deletion)"
          echo "Effective EBS test flags: ${EBS_TEST_FLAGS}"
          scripts/ebs_cleanup.sh ${EBS_TEST_FLAGS:-} -m "${months}" unattached --region "${AWS_REGION}" --dry-run | tee /tmp/ebs_preview.txt
          [[ -f ebs_candidates.txt ]] || touch ebs_candidates.txt

      - name: Upload EBS Preview Artifacts
        if: ${{ inputs.cleanup_type == 'ebs' || inputs.cleanup_type == 'both' }}
        uses: actions/upload-artifact@v4
        with:
          name: ebs-preview-${{ needs.build-matrix.outputs.account_name }}
          path: |
            /tmp/ebs_preview.txt
            ebs_candidates.txt

  ami-live:
    name: AMI Delete (Live) (${{ needs.build-matrix.outputs.account_name }})
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets, preview]
    if: ${{ inputs.cleanup_type == 'ami' || inputs.cleanup_type == 'both' }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve AWS Account Number
        run: |
          ACCOUNT_NUMBER=$(jq -r -e --arg n "${{ needs.build-matrix.outputs.account_name }}" '.account_ids[$n]' <<< '${{ needs.fetch-secrets.outputs.environment_management }}')
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=$ACCOUNT_NUMBER" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions
          role-session-name: ami-delete-${{ needs.build-matrix.outputs.account_name }}
          aws-region: ${{ env.AWS_REGION }}

      # >>> NEW: enable 10-minute test flags in LIVE when requested
      - name: Set 10-minute test flags (LIVE)
        if: ${{ inputs.live_test_mode == true }}
        run: |
          echo "AMI_TEST_FLAGS=--test-mode --age-minutes 10" >> $GITHUB_ENV
      # <<<

      - name: Recompute & Delete AMIs (Live)
        env:
          AMI_ARGS: "-c -m 3"
        run: |
          set -euo pipefail
          echo "[LIVE] Collecting candidates and deregistering (if any)"
          scripts/ami_cleanup.sh ${AMI_TEST_FLAGS:-} ${AMI_ARGS} --region "${AWS_REGION}" --execute | tee /tmp/ami_live.txt
          [[ -f ami_commands.sh ]] || true

      - name: Upload AMI Live Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ami-live-${{ needs.build-matrix.outputs.account_name }}
          path: |
            /tmp/ami_live.txt
            ami_commands.sh

  ebs-live:
    name: EBS Delete (Live) (${{ needs.build-matrix.outputs.account_name }})
    runs-on: ubuntu-latest
    needs: [build-matrix, fetch-secrets, preview]
    if: ${{ inputs.cleanup_type == 'ebs' || inputs.cleanup_type == 'both' }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve AWS Account Number
        run: |
          ACCOUNT_NUMBER=$(jq -r -e --arg n "${{ needs.build-matrix.outputs.account_name }}" '.account_ids[$n]' <<< '${{ needs.fetch-secrets.outputs.environment_management }}')
          echo "::add-mask::$ACCOUNT_NUMBER"
          echo "ACCOUNT_NUMBER=$ACCOUNT_NUMBER" >> $GITHUB_ENV

      - name: Configure AWS Credentials (github-actions role)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_NUMBER }}:role/github-actions
          role-session-name: ebs-delete-${{ needs.build-matrix.outputs.account_name }}
          aws-region: ${{ env.AWS_REGION }}

      # >>> NEW: enable 10-minute test flags in LIVE when requested
      - name: Set 10-minute test flags (LIVE)
        if: ${{ inputs.live_test_mode == true }}
        run: |
          echo "EBS_TEST_FLAGS=--test-mode --age-minutes 10" >> $GITHUB_ENV
      # <<<

      - name: Delete EBS Volumes (Live)
        env:
          EBS_MONTHS: 1
        run: |
          set -euo pipefail
          months="${EBS_MONTHS}"
          echo "[LIVE] Deleting unattached EBS volumes older than 1 month(s)"
          scripts/ebs_cleanup.sh ${EBS_TEST_FLAGS:-} -m "${months}" unattached --region "${AWS_REGION}" --execute | tee /tmp/ebs_live.txt

      - name: Upload EBS Live Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ebs-live-${{ needs.build-matrix.outputs.account_name }}
          path: /tmp/ebs_live.txt